# NIXで構築するpython環境

エンジニア作業飲み集会アドカレ3日目はpython環境についてです。

機械学習を用いた研究をしていると「先輩のコードが動かない」、
「公開されている古いプロジェクトのメンテが終了しており新規環境で動かない」ということに直面し、
環境構築に多くの時間が割かれるという悲劇に見舞わることが多々あります。

しかし、NIXを用いることでそのような悲劇を極限まで回避できることができます。

## NIXとは

[公式HP](https://nixos.org)で以下のように紹介されています。

```
Nix is a tool that takes a unique approach to package management and system configuration.
Learn how to make reproducible, declarative and reliable systems.
```

`nix`は非常に優秀なパッケージマネージャーです。  
他のパッケージマネージャーと異なりグローバルにパッケージがインストールされることはありません。(`/usr/bin`や`/usr/lib`の中に何もない)  
そのため、依存関係が不十分であればビルドが失敗するため依存関係の記載漏れのリスクが少なくなります。  
また、各パッケージはハッシュで管理されており同一バージョンのパッケージでも依存関係のバージョンが異なれば別々で扱われます。  
例え依存関係の破壊的変更によりパッケージが動作しなくてもロールバックによって以前の状態に戻すことが容易に可能です。

以前の`nix`では`nixpkgs`(パッケージリポジトリ)は導入した時点のものが使用されるために今日ビルドできても明日ビルドできない可能性がありました。  
しかし、[Flakes](https://nixos.wiki/wiki/Flakes)の登場によってこの問題の解決が図られました。  
Flakesは宣言的な入力(依存するリポジトリなど)と出力、Lockファイルによるピンニングにより、いつどのような環境でビルドしても同一のバイナリが生成されることを保証します。

## 現在のpython環境の問題

[poetry]()や[rye]()の登場によって、pythonの依存パッケージについてLockファイルの生成による再現可能な環境の構築ができるようになりました。  
しかし、CUDAやBLASのようなpython外の依存関係を用いる場合にはシステムにインストールされているバージョンに左右されるため再現できない問題が生じます。  
dockerなどのdev containerを用いることで一応の解決はできますが、依存関係の記載漏れ、パッケージバージョンの不明記などのリスクにより再現性には難があります。

## Project Templates

[nix-templates]()に今回作成した環境のテンプレートを置いておきます。(overrideを除く)
適宜参照してください。

## NIXで構築するpython環境 (poetry2nix)

python外の依存関係を`nix`によって、pythonパッケージを`poetry`で解決することで先の問題を解決しつつ可搬性のある環境を構築できます。  
厳密にはpoetryで生成された`poetry.lock`を解析し`nix dervation`の形式に変換することで`nix`によってpythonパッケージを管理します。  
可搬性については`poetry export`によって`requirement.txt`を生成することで、`nix`が導入されていないシステムでもpython環境を`pip`で構築することが可能です。  
また、[devenv]()により環境をコンテナに固めることができるので動作させるだけなら`nix`を知らない人にも共有することが可能です。

### How to

```nix

```

## NIXで構築するpython環境 (nix+poetry)

上記の場合の構築は厳格に構築できる反面、`nix`についてある程度の知識がないと依存関係を解決できないという問題があります。  
ここでは、python外の依存関係については引き続き`nix`を用い、pythonパッケージを`poetry`で解決する方法を紹介します。  
`poetry`を`rye`に置き換えることも可能です。  
この方法では`nix`の知識はそれほど必要ありませんが、再現性では劣りまた環境変数を駆使するために開発シェル外のappの動作に支障を及ぼす場合があります。

```nix

```

## まとめ

ここまででNIXを使ったpython環境の構築を行ってきました。  
読んでいただいたようにNIX上でpython環境を構築するのは非常に複雑で難易度が高いです。  
これはpythonパッケージが命令型の管理であるのに対し`nix`が宣言型の管理であることに由来し、現在もコミュニティによって様々な手法が検討されています。
